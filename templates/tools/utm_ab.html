<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Builder & A/B Link Testing | LinkShort</title>
    <meta name="description"
        content="Create UTM tagged links and test multiple variants with A/B link testing. Bulk UTM support included.">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <div class="background-glow"></div>
    {% include 'partials/_navbar.html' %}

    <main class="page-content tool-page">
        <section class="tool-header">
            <h1>UTM Builder & A/B Link Testing</h1>
            <p>Create trackable UTM links and test multiple variants with A/B testing.</p>
        </section>

        <section class="tool-ui-section">
            <!-- UTM BUILDER -->
            <div class="glass-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">UTM Link Builder</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="grid-column: span 2;">
                        <label class="input-label">Website URL *</label>
                        <input type="text" id="utmUrl" placeholder="https://example.com" oninput="generateUtm()">
                    </div>
                    <div>
                        <label class="input-label">Campaign Source *</label>
                        <input type="text" id="utmSource" placeholder="google, facebook" oninput="generateUtm()">
                    </div>
                    <div>
                        <label class="input-label">Campaign Medium *</label>
                        <input type="text" id="utmMedium" placeholder="cpc, email, social" oninput="generateUtm()">
                    </div>
                    <div>
                        <label class="input-label">Campaign Name *</label>
                        <input type="text" id="utmCampaign" placeholder="summer_sale" oninput="generateUtm()">
                    </div>
                    <div>
                        <label class="input-label">Campaign Term</label>
                        <input type="text" id="utmTerm" placeholder="running+shoes" oninput="generateUtm()">
                    </div>
                    <div style="grid-column: span 2;">
                        <label class="input-label">Campaign Content</label>
                        <input type="text" id="utmContent" placeholder="logolink, textlink" oninput="generateUtm()">
                    </div>
                </div>

                <div id="utmResult"
                    style="margin-top: 2rem; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 12px; word-break: break-all; font-family: monospace; min-height: 3rem;">
                    Fill in the fields above...
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                    <button class="copy-btn" onclick="copyUtmLink()">Copy Link</button>
                    <button class="copy-btn" onclick="downloadUtmCsv()"
                        style="background: rgba(16, 185, 129, 0.1); color: var(--accent-primary);">Download CSV</button>
                </div>
            </div>

            <!-- BULK UTM -->
            <div class="glass-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Bulk UTM Generator</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Upload a CSV with columns: url, source,
                    medium, campaign, term, content</p>
                <label for="bulkUtmFile" class="file-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path
                            d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                    </svg>
                    Upload CSV
                </label>
                <input type="file" id="bulkUtmFile" accept=".csv" style="display: none;"
                    onchange="handleBulkUtmUpload(this)">
                <div id="bulkUtmStatus" style="margin-top: 1rem; color: var(--text-secondary);"></div>
                <button id="generateBulkUtmBtn" class="btn btn-primary" style="margin-top: 1rem;"
                    onclick="generateBulkUtm()" disabled>Generate Bulk UTM</button>
                <button id="downloadBulkUtmBtn" class="copy-btn" style="margin-top: 0.5rem; display: none;"
                    onclick="downloadBulkUtmCsv()">Download Bulk UTM CSV</button>
            </div>

            <!-- A/B TESTING -->
            <div class="glass-card">
                <h3 style="margin-bottom: 1rem;">A/B Link Testing</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Create an A/B test to split traffic
                    between two link variants.</p>
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label class="input-label">Test Name</label>
                        <input type="text" id="abTestName" placeholder="Homepage Button Test">
                    </div>
                    <div>
                        <label class="input-label">Variant A (URL)</label>
                        <input type="text" id="abVariantA" placeholder="https://example.com/landing-a">
                    </div>
                    <div>
                        <label class="input-label">Variant B (URL)</label>
                        <input type="text" id="abVariantB" placeholder="https://example.com/landing-b">
                    </div>
                    <div>
                        <label class="input-label">Traffic Split (% to Variant A)</label>
                        <input type="range" id="abTrafficSplit" min="10" max="90" value="50" style="width: 100%;"
                            oninput="document.getElementById('splitLabel').innerText = this.value + '% / ' + (100 - this.value) + '%'">
                        <div id="splitLabel"
                            style="text-align: center; color: var(--text-secondary); margin-top: 0.5rem;">50% / 50%
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="createAbTest()">Start A/B
                    Test</button>
                <div id="abTestResult" style="margin-top: 1.5rem;"></div>
            </div>
        </section>

        <section class="seo-content">
            <h2>What are UTM Parameters?</h2>
            <p style="color: var(--text-secondary); line-height: 1.8;">UTM parameters are tags added to URLs that help
                you track the performance of your marketing campaigns in analytics tools like Google Analytics.</p>

            <h3>A/B Testing Benefits</h3>
            <ul style="color: var(--text-secondary); line-height: 2;">
                <li>Test different landing pages to see which converts better</li>
                <li>Optimize marketing spend by directing traffic to winning variants</li>
                <li>Make data-driven decisions on campaign performance</li>
            </ul>

            <div style="margin-top: 2rem;">
                <a href="/" class="btn btn-secondary">← Back to Home</a>
            </div>
        </section>
    </main>

    {% include 'partials/_footer.html' %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let bulkUtmData = [];
        let bulkUtmResults = [];

        function generateUtm() {
            const url = document.getElementById('utmUrl').value.trim();
            const source = document.getElementById('utmSource').value.trim();
            const medium = document.getElementById('utmMedium').value.trim();
            const campaign = document.getElementById('utmCampaign').value.trim();
            const term = document.getElementById('utmTerm').value.trim();
            const content = document.getElementById('utmContent').value.trim();
            const result = document.getElementById('utmResult');

            if (!url) { result.innerText = "Enter a Website URL to begin..."; return; }

            try {
                let u = new URL(url);
                if (source) u.searchParams.set('utm_source', source);
                if (medium) u.searchParams.set('utm_medium', medium);
                if (campaign) u.searchParams.set('utm_campaign', campaign);
                if (term) u.searchParams.set('utm_term', term);
                if (content) u.searchParams.set('utm_content', content);
                result.innerText = u.toString();
            } catch (e) {
                result.innerText = "Invalid URL";
            }
        }

        async function copyUtmLink() {
            const link = document.getElementById('utmResult').innerText;
            if (link.startsWith('http')) {
                await navigator.clipboard.writeText(link);
                alert('Copied!');
            }
        }

        function downloadUtmCsv() {
            const link = document.getElementById('utmResult').innerText;
            if (!link.startsWith('http')) return;
            const csv = "UTM Link\n" + link;
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'utm-link.csv';
            a.click();
        }

        function handleBulkUtmUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const status = document.getElementById('bulkUtmStatus');
            const btn = document.getElementById('generateBulkUtmBtn');

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    bulkUtmData = XLSX.utils.sheet_to_json(sheet);
                    status.innerText = `✅ Loaded ${bulkUtmData.length} rows.`;
                    status.style.color = '#22c55e';
                    btn.disabled = false;
                } catch (err) {
                    status.innerText = "❌ Error reading file.";
                    status.style.color = '#ef4444';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function generateBulkUtm() {
            bulkUtmResults = bulkUtmData.map(row => {
                try {
                    let u = new URL(row.url || row.URL || '');
                    if (row.source) u.searchParams.set('utm_source', row.source);
                    if (row.medium) u.searchParams.set('utm_medium', row.medium);
                    if (row.campaign) u.searchParams.set('utm_campaign', row.campaign);
                    if (row.term) u.searchParams.set('utm_term', row.term);
                    if (row.content) u.searchParams.set('utm_content', row.content);
                    return u.toString();
                } catch (e) { return 'Invalid URL'; }
            });
            document.getElementById('bulkUtmStatus').innerText = `✅ Generated ${bulkUtmResults.length} UTM links.`;
            document.getElementById('downloadBulkUtmBtn').style.display = 'inline-block';
        }

        function downloadBulkUtmCsv() {
            const csv = "Original URL,UTM Link\n" + bulkUtmData.map((row, i) => `"${row.url || row.URL}","${bulkUtmResults[i]}"`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bulk-utm-links.csv';
            a.click();
        }

        function createAbTest() {
            const name = document.getElementById('abTestName').value.trim();
            const varA = document.getElementById('abVariantA').value.trim();
            const varB = document.getElementById('abVariantB').value.trim();
            const split = document.getElementById('abTrafficSplit').value;
            const result = document.getElementById('abTestResult');

            if (!name || !varA || !varB) {
                result.innerHTML = '<span style="color: var(--error);">Please fill in all fields.</span>';
                return;
            }

            // Generate a simple test link (in production, this would call an API)
            const testId = Math.random().toString(36).substring(2, 8);
            result.innerHTML = `
                <div class="glass-card" style="padding: 1.5rem; margin-top: 1rem;">
                    <p style="color: var(--success); font-weight: 700;">✅ A/B Test Created!</p>
                    <p style="margin-top: 1rem; color: var(--text-secondary);">Test ID: <strong>${testId}</strong></p>
                    <p style="color: var(--text-secondary);">Variant A (${split}%): ${varA}</p>
                    <p style="color: var(--text-secondary);">Variant B (${100 - split}%): ${varB}</p>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-sub);">(This is a demo. Full tracking coming soon.)</p>
                </div>
            `;
        }
    </script>
</body>

</html>